# 计算机网络

## 概述

* 局域网
  覆盖范围小 自己买设备 带宽固定 自己维护
* 广域网
* 子网掩码 几个255标志了前几段是网络部分，后面是主机部分

* 数据包： 数据+源地址+目标地址

数据帧：再+源mac地址+目标mac地址
ip地址决定了出发地和终点，mac地址则决定当前位置和下一步位置
​			交换机看mac地址，路由器看ip地址
​			发数据后接收到会发回确认，然后再发送
​		应用层：所有能产生网络流量的程序
​		表示层：在传输之前是否进行加密或压缩处理 二进制ascii
​		会话层：
​		传输层：可靠传输、流量控制、不可靠传输
​		网络层：负责选择最佳路径 规划ip地址
​		数据链路层：真的开始和结束 透明传输 差错检验
​		物理层：接口标准 电器标准
​		OSI参考模型对网络排错指导
​			物理层故障：查看连接状态、发送和接收的数据包
​			数据链路层故障：mac冲突、adsl欠费、网速不匹配、计算机连接到错误的VLAN
​			网络层故障：配置错ip地址、子网掩码、配置错网关、路由器没有配置到达目标网络的路由
​			应用层故障：应用程序配置错误
​		OSI参考模型和网络安全
​			物理层安全
​			数据链路层安全 ADSL账号密码、VLAN交换机端口绑定mac地址
​			网络层安全
​		TCP/IP协议栈
​			应用表示会话层 HTTP FTP DNS                                  上层数据
​			传输层：TCP/UDP				                          TCP头+          ->数据段或消息       
​			网络层：ARP IP ICMP IGMP					     IP头+				  ->数据包
​			数据链路 物理层： Ethernet ATM Frame Relay mac头+                     +FCS->数据帧
​		计算机网络性能
​			速率：主机在数字信道上传送数据位数的速率
​			带宽：数字信道所能传送的最高数据率
​			吞吐量：单位时间内通过某个网络的吞吐量
​			时延：发送时延、传播时延、处理时延、排队时延
​			时延带宽积：即线路上有多少数据
​			往返时间：RTT(Round-Trip Time)
​			网路利用率：信道利用率、网络利用率
​	数据链路层
​		基本概念
​		三个基本问题
​			封装成帧 帧首部+IP数据报+帧尾部
​				帧开始符SOH			+帧结束符EOT
​			透明传输
​				若数据中出现控制字符则进行字符填充 +转义字符ESC（十六进制1B）
​			差错检验
​				循环冗余检验CRC 计算FCS 余数R为0则无差错就接收，1则有差错就丢弃
​				不能确定差错具体位置，除数越大，检测不到异常的概率越小
​		两种情况
​			使用点对点信道：点对点通信
​				PPP协议：可以封装成帧、透明传输、多种网络层协议、多种类型链路、差错检测、检测连接状态
​				网络层地址协商、数据压缩协商、不能流量控制、不能纠错、不能多点线路
​					协议帧格式：首部FAC+协议+信息部分（不超过1500字节）+尾部FCS+F
​					透明传输时若为字节流则ESC填充，二进制流则0填充
​				信道复用技术：
​					频分复用：频分复用的所有主机在相同的时间占用不同的频率带宽资源
​					时分复用：时分复用的所有主机在不同的时间占用相同的频率带宽资源
​					统计时分复用：是对时分复用的一种改进，不固定每个用户在时分复用帧中的位置，只要有数据就集中起来组成统计时分复用帧然后发送
​					波分复用：光的频分复用。由于光的频率很高，因此习惯上用波长而不是频率来表示所使用的光载波
​					码分复用：码分复用需要发送的数据量为原先的 m 倍
​			使用广播信道：一对多的广播通信
​				CSMA/CD
​					以太网采用->动态媒体接入控制多点接入->随机接入
​		以太局域网
​			以太网提供的服务时不可靠的交付，即尽最大努力的交付
​			MAC层：
​				硬件地址mac地址
​				单播帧、广播帧、多播帧
​				Mac帧格式：
​					物理层：8字节+ 		        以太网Mac帧
​					Mac层：		   目标地址6+源地址6+类型2+数据46-1500+FCS4
​					IP层：              			IP数据报
​					若mac帧小于64字节则补足成64 抓包时如果校验成功时看不到FCS的
​		扩展局域网
​			通过交换机实现，交换端口带宽独享 安全 基于mac地址转发 通过学习构建mac表
​		高速以太网
​	网络层
​		网络层提供的服务：
​			网络层只负责尽力分发数据包，并不负责管理丢包重传以及顺序
​			计算机通信的过程，就是本网段通信跨网段通信的过程
​			发送端
​				应用程序准备要传输的文件
​				传输层 将文件分段并编号
​				网络层 添加目标IP地址源IP地址
​				数据链路层 两种情况 使用自己的子网掩码 判断自己在那个网段和目标地址在哪个网段
​			发送数据的过程
​				应用层把数据依次封装成数据帧报帧进入物理层，经交换机存储转发给路由（路由点对点为FF，再
​				经过又物理层依次解封装将数据返回给应用层，每一层只能看到本层的数据流动
​			ARP协议
​				为IP协议提供服务，是数据传输之前的服务
​				ARP将IP地址通过广播 目标MAC地址是FF-FF-FF-FF-FF 解析目标IP地址的MAC地址，
​				仅在本网段中传播广播包
​			ICMP协议
​				测试网络层是否畅通 ping命令 Packet Internet Grope
​				TTL 生存周期 可以经过多少次路由器 Linux一般64、windows一般128、Unix一般255
​				pathping 跟踪数据报路径 计算丢包情况
​			IGMP协议
​				组播=多播
​				路由器扫描本网段有哪些绑定了多播地址，决定是否接收多播数据
​				多播不建立会话

​			RARP协议

​				RARP是逆地址解析协议，作用是完成硬件地址到IP地址的映射，主要用于无盘工作站，因为给无盘工作站配置的IP地址不能保存。工作流程：在网络中配置一台RARP服务器，里面保存着IP地址和MAC地址的映射关系，当无盘工作站启动后，就封装一个RARP数据包，里面有其MAC地址，然后广播到网络上去，当服务器收到请求包后，就查找对应的MAC地址的IP地址装入响应报文中发回给请求者。因为需要广播请求报文，因此RARP只能用于具有广播能力的网络。

​			IP数据包结构<img src="C:/Users/hawk4/Desktop/Temp/笔记/笔记图片/image-20191215170714885.png" alt="image-20191215170714885" style="zoom:50%;" />

​				数据报最大可以为65535，而数据报可能根据数据链路最大传输单元MTU决定分片：若发送的数据超过1500字节则分片为每个1500字节的数据包进行发送，其中用标识相同的包一个完整数据报的合并，其中标志部分最低位MF(More Fragment)为1时则后面还有分片，为0则是最后一个分片，中间位DF(Don't Fragment),仅当位0时才可以进行分片

​				生存时间TTL Time to live，协议指明数据交给谁处理，ICMP协议号 1，IGMP 2，TCP 6，UDP 17，IPv6 41，OSPF 89

​				总共20字节的固定部分，可选部分1-40字节

​			IP协议

​				网络畅通的条件 数据包有去有回

​		传输层的功能

​			传输层协议

​			TCP协议 需要将传输的文件分段 传输建立会话 可靠传输 流量控制

​			UDP 一个数据包就能完成数据通信 不许要建立会话 不需要流量控制 进行不可靠传输 （多播广播应用

​			查看会话netstat -n

​		传输层协议与应用层协议之间的关系

​            			<img src="C:/Users/hawk4/Desktop/Temp/笔记/笔记图片/QQ截图20191215215250.png" alt="QQ截图20191215215250" style="zoom:67%;" />

​				TCP or UDP+端口 可以作为一个协议标识 http=TCP+80  https=TCP+443 PoP3=TCP+110 SQL=TCP+1433

​			服务和应用层协议之间关系

​				服务使用 TCP或UDP的端口侦听客户端请求；客户端使用IP地址定位服务器 使用目标端口定位服务；可以再服务器网卡上设置只开放必要的接口实现服务器网络安全

​			传输层功能 为相互通信的应用进程提供了逻辑通信、对收到的报文进行差错检测、提供面向连接和无连接的服务

​			端口号只有本地意义，不应该冲突，但因特网中不同计算机的相同端口号是没有联系的，端口号0-65535，熟知的端口一般0-1023，登记端口为1024-49151，客户端端口49152-65535 -netstat -n|find "ESTABLISHED"

​		UDP

​			特点：UDP是无连接的，发送数据之前不需要建立连接、尽最大努力交付，不保证可靠交付也不是用拥塞控制、面向报文、支持一对一、一对多、多对一、多对多的交互通信、首部开销小只有8个字节

​			UDP首部格式

<img src="C:/Users/hawk4/Desktop/Temp/笔记/笔记图片/QQ截图20191215222754.png" alt="QQ截图20191215222754" style="zoom: 50%;" />

​			伪首部从网络层中提取，剩下8个字节为UDP的真首部

​		TCP

​			特点：TCP是面向连接的传输层协议、每一条TCP连接只能有两个端点，每一条TCP连接只能是点对点的，提供可靠交付的服务、提供全双工通信、面向字节流，TCP把连接作为基本的抽象，TCP连接的端点为套接字socket，socket=(IP地址:端口号)，每一条TCP连接唯一地通信两端的两个端点所确定

​			TCP首部格式

​    			           <img src="C:/Users/hawk4/Desktop/Temp/笔记/笔记图片/QQ截图20191215231102.png" alt="QQ截图20191215231102" style="zoom: 67%;" /> 

​				 首部不固定，固定部分20字节，后面选项长度可变，序号指本数据包段首为整个数据的第几个字节，而确认号为下次传输的起始数据序号，URG标识数据包紧急程度，ACK为0时确认号有效，为1时无效，SYN为1建立请求，窗口为相互协商的接收发送缓存大小，校验和与UDP一样需要网络层中的信息作为伪首部进行判断，紧急指针指向紧急信息的尾部

​			可靠传输：				

​				ARQ自动重传请求协议：无丢失情况、超时重传、确认丢失、确认迟到，为了提高信道利用率，采用流水线可采用流水线传输

​				连续ARQ协议：滑动窗口实现连续传输，最前沿的数据收到确认后先后滑动

​				累计确认进行优化，通过发送端确认最后一个没有发生丢失的数据作为滑动窗口的位置

<img src="C:/Users/hawk4/Desktop/Temp/笔记/笔记图片/QQ截图20191215230818.png" alt="QQ截图20191215230818" style="zoom:67%;" />

​			流量控制：

​				滑动窗口可变，根据接收缓存剩余大小来决定窗口大小，窗口大小为0时停止发送，发送端定时向接收端确认窗口大小，避免了接收端回复消息的丢失

​			拥塞控制：

​				出现资源拥塞的条件 对资源需求的哦在那个和>可用资源 拥塞控制是一个全局性的过程，拥塞避免指用色窗口控制为按线性规律增长，使网络比较不容易出现拥塞

​				慢重传在出现丢包时在最后一个分片数据包的最后一段到达才发送重传请求，而快重传则在出现丢包后立即发送重传请求，快重传配套使用了快恢复，窗口门限从12开始线性增长与慢开始的从1开始指数增长到12不同

​			传输连接管理：

​				TCP连接建立：三次握手

​				第一次握手：客户端发送syn包(syn=1，seq=x)到服务器，并进入SYN_SEND状态，等待服务器确认；

​				第二次握手：服务器收到syn包，必须确认客户的SYN（ack=x+1），同时自己也发送一个SYN包（syn=1，seq=y），即SYN+ACK包，此时服务器进入SYN_RECV状态；

​				第三次握手：客户端收到服务器的SYN＋ACK包，向服务器发送确认包ACK(ack=y+1)，此包发送完毕，客户端和服务器进入ESTABLISHED状态，完成三次握手。

​				握手过程中传送的包里不包含数据，三次握手完毕后，客户端与服务器才正式开始传送数据。理想状态下，TCP连接一旦建立，在通信双方中的任何一方主动关闭连接之前，TCP 连接都将被一直保持下去。

​				为什么需要三次握手而不是两次https://www.jianshu.com/p/4d39863e62ab

​				TCP连接释放：四次挥手

​				与建立连接的“三次握手”类似，断开一个TCP连接则需要“四次挥手”。

​				第一次挥手：主动关闭方发送一个FIN，用来关闭主动方到被动关闭方的数据传送，也就是主动关闭方告诉被动关闭方：我已经不 会再给你发数据了(当然，在fin包之前发送出去的数据，如果没有收到对应的ack确认报文，主动关闭方依然会重发这些数据)，但是，此时主动关闭方还可 以接受数据。

​				第二次挥手：被动关闭方收到FIN包后，发送一个ACK给对方，确认序号为收到序号+1（与SYN相同，一个FIN占用一个序号）。
​				第三次挥手：被动关闭方发送一个FIN，用来关闭被动关闭方到主动关闭方的数据传送，也就是告诉主动关闭方，我的数据也发送完了，不会再给你发数据了。
​				第四次挥手：主动关闭方收到FIN后，发送一个ACK给被动关闭方，确认序号为收到序号+1，至此，完成四次挥手。               

​                         <img src="C:/Users/hawk4/Desktop/Temp/笔记/笔记图片/092017231747399.jpg" alt="092017231747399" style="zoom:67%;" />

​		应用层

​			DNS服务作用 负责解析域名 将域名解析成IP

​			域名： 根->顶级域名->二级域名

​			域名解析的过程：DNS 可以使用 UDP 或者 TCP 进行传输，使用的端口号都为 53。大多数情况下 DNS 使用 UDP 进行传输，这就要求域名解析器和域名服务器都必须自己处理超时和重传从而保证可靠性。在两种情况下会使用 TCP 进行传输：如果返回的响应超过的 512 字节（UDP 最大只支持 512 字节的数据）、区域传送（区域传送是主域名服务器向辅助域名服务器传送变化的那部分数据）。

​			DHCP动态主机配置

​				静态IP地址、动态IP地址

​				DHCP 配置的内容不仅是 IP 地址，还包括子网掩码、网关 IP 地址。DHCP 工作过程如下：

​				客户端发送 Discover 报文，该报文的目的地址为 255.255.255.255:67，源地址为 0.0.0.0:68，被放入 UDP 中，该报文被广播到同一个子网的所有主机上。如果客户端和 DHCP 服务器不在同一个子网，就需要使用中继代理。

​				DHCP 服务器收到 Discover 报文之后，发送 Offer 报文给客户端，该报文包含了客户端所需要的信息。因为客户端可能收到多个 DHCP 服务器提供的信息，因此客户端需要进行选择。

​				如果客户端选择了某个 DHCP 服务器提供的信息，那么就发送 Request 报文给该 DHCP 服务器。

​				DHCP 服务器发送 Ack 报文，表示客户端此时可以使用提供给它的信息。

​			TELNET远程登陆协议

​				TELNET 用于登录到远程主机上，并且远程主机上的输出也会返回。TELNET 可以适应许多计算机和操作系统的差异，例如不同操作系统系统的换行符定义。

​			电子邮件协议

​				一个电子邮件系统由三部分组成：用户代理、邮件服务器以及邮件协议。邮件协议包含发送协议和读取协议，发送协议常用 SMTP，读取协议常用 POP3 和 IMAP。![电子邮件协议](C:/Users/hawk4/Desktop/Temp/笔记/笔记图片/电子邮件协议.png)

​				SMTP：SMTP 只能发送 ASCII 码，而互联网邮件扩充 MIME 可以发送二进制文件。MIME 并没有改动或者取代 SMTP，而是增加邮件主体的结构，定义了非 ASCII 码的编码规则

​				POP3：POP3 的特点是只要用户从服务器上读取了邮件，就把该邮件删除。但最新版本的 POP3 可以不删除邮件

​				IMAP：IMAP 协议中客户端和服务器上的邮件保持同步，如果不手动删除邮件，那么服务器上的邮件也不会被删除。IMAP 这种做法可以让用户随时随地去访问服务器上的邮件

​			FTP文件传输协议

​				使用两个连接，TCP控制连接端口21和TCP数据连接端口20

​				主动模式 ftp客户端通知FTP服务器使用20端口侦听，FTP服务器和客户端的此端口建立连接 

​				被动模式 FTP服务器打开一个端口，等待客户端发起连接

​				传输模式

​					文本模式：ASCII模式，以文本序列传输数据 二进制模式：Binary模式，以二进制序列传输数据

​			HTTP超文本传输协议 使用TCP连接

​				统一资源定位符 URL 标准格式 <协议>:/?<主机>:<端口>/<路径>

​				超文本标记语言 HTML

​			Web 页面请求过程

​			DHCP 配置主机信息
​				假设主机最开始没有 IP 地址以及其它信息，那么就需要先使用 DHCP 来获取。

​				主机生成一个 DHCP 请求报文，并将这个报文放入具有目的端口 67 和源端口 68 的 UDP 报文段中。

​				该报文段则被放入在一个具有广播 IP 目的地址(255.255.255.255) 和源 IP 地址（0.0.0.0）的 IP 数据报中。

​				该数据报则被放置在 MAC 帧中，该帧具有目的地址 FF:FF:FF:FF:FF:FF，将广播到与交换机连接的所有设备。连接在交换机的 DHCP 服务器收到广播帧之后，不断地向上分解得到 IP 数据报、UDP 报文段、DHCP 请求报文，之后生成 DHCP ACK 报文，该报文包含以下信息：IP 地址、DNS 服务器的 IP 地址、默认网关路由器的 IP 地址和子网掩码。该报文被放入 UDP 报文段中，UDP 报文段有被放入 IP 数据报中，最后放入 MAC 帧中。

​				该帧的目的地址是请求主机的 MAC 地址，因为交换机具有自学习能力，之前主机发送了广播帧之后就记录了 MAC 地址到其转发接口的交换表项，因此现在交换机就可以直接知道应该向哪个接口发送该帧。

​				主机收到该帧后，不断分解得到 DHCP 报文。之后就配置它的 IP 地址、子网掩码和 DNS 服务器的 IP 地址，并在其 IP 转发表中安装默认网关。

​			ARP 解析 MAC 地址
​				主机通过浏览器生成一个 TCP 套接字，套接字向 HTTP 服务器发送 HTTP 请求。为了生成该套接字，主机需要知道网站的域名对应的 IP 地址。

​				主机生成一个 DNS 查询报文，该报文具有 53 号端口，因为 DNS 服务器的端口号是 53。

​				该 DNS 查询报文被放入目的地址为 DNS 服务器 IP 地址的 IP 数据报中。

​				该 IP 数据报被放入一个以太网帧中，该帧将发送到网关路由器。

​				DHCP 过程只知道网关路由器的 IP 地址，为了获取网关路由器的 MAC 地址，需要使用 ARP 协议。

​				主机生成一个包含目的地址为网关路由器 IP 地址的 ARP 查询报文，将该 ARP 查询报文放入一个具有广播目的地址（FF:FF:FF:FF:FF:FF）的以太网帧中，并向交换机发送该以太网帧，交换机将该帧转发给所有的连接设备，包括网关路由器。

​				网关路由器接收到该帧后，不断向上分解得到 ARP 报文，发现其中的 IP 地址与其接口的 IP 地址匹配，因此就发送一个 ARP 回答报文，包含了它的 MAC 地址，发回给主机。

​			DNS 解析域名
​				知道了网关路由器的 MAC 地址之后，就可以继续 DNS 的解析过程了。

​				网关路由器接收到包含 DNS 查询报文的以太网帧后，抽取出 IP 数据报，并根据转发表决定该 IP 数据报应该转发的路由器。

​				因为路由器具有内部网关协议（RIP、OSPF）和外部网关协议（BGP）这两种路由选择协议，因此路由表中已经配置了网关路由器到达 DNS 服务器的路由表项。

​				到达 DNS 服务器之后，DNS 服务器抽取出 DNS 查询报文，并在 DNS 数据库中查找待解析的域名。

​				找到 DNS 记录之后，发送 DNS 回答报文，将该回答报文放入 UDP 报文段中，然后放入 IP 数据报中，通过路由器反向转发回网关路由器，并经过以太网交换机到达主机。

​			HTTP 请求页面
​				有了 HTTP 服务器的 IP 地址之后，主机就能够生成 TCP 套接字，该套接字将用于向 Web 服务器发送 HTTP GET 报文。

​				在生成 TCP 套接字之前，必须先与 HTTP 服务器进行三次握手来建立连接。生成一个具有目的端口 80 的 TCP SYN 报文段，并向 HTTP 服务器发送该报文段。

​				HTTP 服务器收到该报文段之后，生成 TCP SYN ACK 报文段，发回给主机。

​				连接建立之后，浏览器生成 HTTP GET 报文，并交付给 HTTP 服务器。

​				HTTP 服务器从 TCP 套接字读取 HTTP GET 报文，生成一个 HTTP 响应报文，将 Web 页面内容放入报文主体中，发回给主机。

​				浏览器收到 HTTP 响应报文后，抽取出 Web 页面内容，之后进行渲染，显示 Web 页面。